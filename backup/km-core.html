<!--
KM-CORE ‚Äî BASELINE APROVADO
- Assets locais (Cloudflare)
- feriados.json versionado
- Motor de c√°lculo espelha calckm.aspx
- N√ÉO usar endpoints SharePoint
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Remunera√ß√£o por KM Voado ‚Äî BLACK Avia√ß√£o</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- XLSX (Excel reader) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --page-bg:#0f172a;
      --card-bg:#0b1220;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,.12);
      --border-subtle:rgba(148,163,184,.25);
      --text-primary:#e5e7eb;
      --text-muted:#9ca3af;
    }

    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      color:var(--text-primary);
    }

    #blaq-km{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:2.5rem 1rem;
    }

    .card{
      width:100%;
      max-width:1200px;
      background:radial-gradient(circle at top left, rgba(56,189,248,.12), transparent 55%), var(--card-bg);
      border-radius:1.5rem;
      border:1px solid var(--border-subtle);
      box-shadow:0 24px 60px rgba(15,23,42,.8);
      padding:1.75rem 1.75rem 2rem;
    }

    .tbl th,
    .tbl td{
      white-space:nowrap;
      padding:.35rem .55rem;
      font-size:.75rem;
    }
    .tbl thead th{
      position:sticky;
      top:0;
      background:rgba(15,23,42,.98);
      backdrop-filter:blur(6px);
      z-index:5;
    }

    .badge-chip{
      padding:.1rem .45rem;
      border-radius:999px;
      font-size:.68rem;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
    }
    .bg-rose-900\/40{
  animation: pulse 1.5s infinite;
}

@keyframes pulse{
  0%   { opacity: 1; }
  50%  { opacity: .6; }
  100% { opacity: 1; }
}
  </style>
</head>

<body>
<div id="blaq-km">
  <div class="card">

    <!-- HEADER BLACK PADR√ÉO -->
    <header class="flex items-center justify-between mb-8 pb-4 border-b border-slate-700/50">
      <div class="flex items-center gap-4">
        <div class="flex flex-col">
          <h1 class="text-xl sm:text-2xl font-semibold text-slate-100 tracking-tight">
            Remunera√ß√£o por KM Voado
          </h1>
          <span class="text-xs text-slate-400">
            M√≥dulo ‚Äî c√°lculo proporcional por faixas hor√°rias
          </span>
        </div>
      </div>

     <a href="dashboard.html"
   class="px-4 py-2 rounded-xl border border-slate-300/40 text-slate-200 hover:bg-slate-700/40 transition text-sm">
  ‚Üê VOLTAR
</a>

    </header>

    <!-- √ÅREA DE UPLOADS -->
    <div class="border border-slate-700/60 rounded-2xl bg-slate-900/60 p-4 mb-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start">

        <!-- PLANILHA DE VOOS -->
        <div class="space-y-2">
          <label class="block text-xs font-medium text-slate-300 mb-1">
            1. Selecione a planilha de voos (.xlsm)
          </label>
          <input id="fileVoos" type="file"
                 accept=".xlsx,.xlsm,.xls"
                 class="block w-full text-xs text-slate-200
                        file:mr-3 file:py-1.5 file:px-3 file:rounded-full
                        file:border-0 file:text-xs file:font-medium
                        file:bg-sky-600 file:text-white
                        hover:file:bg-sky-500 cursor-pointer
                        bg-slate-900/80 border border-slate-700/70 rounded-xl px-2 py-1"/>
          <p class="text-[0.7rem] text-slate-500">
            Mesmo arquivo do m√≥dulo de di√°rias, com abas mensais JANEIRO‚Ä¶DEZEMBRO.
          </p>
        </div>

        <!-- FERIADOS (AUTOLOAD) -->
        <div class="space-y-2">
          <div class="text-xs font-medium text-slate-300">2. Feriados</div>
          <div id="feriadosInfo" class="text-[0.75rem] text-emerald-300">
            Carregando feriados‚Ä¶
          </div>
          <div class="text-[0.7rem] text-slate-500">
            Domingo/feriado = 0,90 o dia inteiro.
          </div>
        </div>

        <!-- SELETOR DE ABA + BOT√ÉO -->
        <div class="space-y-3">
          <div class="space-y-1">
            <div class="flex items-center justify-between gap-2">
              <span class="block text-xs font-medium text-slate-300">
                3. Escolha o m√™s (aba)
              </span>
              <span id="sheetInfo" class="text-[0.65rem] text-slate-500"></span>
            </div>
            <div id="sheetPicker" class="flex flex-wrap gap-1.5"></div>
          </div>

          <div class="flex flex-col gap-2">
            <button id="btnProcessar" type="button"
                    class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl text-xs font-semibold
                           bg-sky-600/90 hover:bg-sky-500 text-white shadow shadow-sky-800/60
                           disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none"
                    disabled>
              <span class="inline-block w-1.5 h-1.5 rounded-full bg-emerald-300"></span>
              Processar remunera√ß√£o
            </button>
          </div>
        </div>

      </div>
    </div>

    <!-- STATUS -->
    <div id="statusBox" class="text-xs text-slate-400 mb-3">
      Selecione a planilha de voos para come√ßar.
    </div>

    <!-- TOTAIS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mb-3">
      <div class="border border-slate-700/60 rounded-2xl bg-slate-900/60 p-3">
        <div class="text-xs text-slate-300 font-semibold mb-2">Totais por Tripulante (100% do voo)</div>
        <div id="totaisTrip" class="flex flex-wrap gap-2 text-xs text-slate-200"></div>
      </div>

      <div class="border border-slate-700/60 rounded-2xl bg-slate-900/60 p-3">
        <div class="text-xs text-slate-300 font-semibold mb-2">Totais por Matr√≠cula / Tripulante</div>
        <div id="totaisMat" class="text-xs text-slate-200 space-y-2"></div>
      </div>
    </div>

    <!-- TABELA -->
    <div class="border border-slate-700/60 rounded-2xl bg-slate-950/70 overflow-hidden">
      <div class="flex items-center justify-between px-3 py-2 border-b border-slate-800/80 bg-slate-950/80">
        <div class="flex items-center gap-2 text-[0.75rem] text-slate-400">
          <span class="w-1.5 h-1.5 rounded-full bg-sky-400"></span>
          Resultado por trecho (hor√°rio local) ‚Äî KM 0,30 / 0,60 / 0,90
        </div>
        <span class="text-[0.7rem] text-slate-500">
          0,30 = 06‚Äì18 ¬∑ 0,60 = 18‚Äì06 ¬∑ 0,90 = domingo/feriado
        </span>
      </div>

      <div class="max-h-[520px] overflow-auto space-y-4">
        <table class="min-w-full text-left text-xs text-slate-200 tbl">
          <thead class="border-b border-slate-800 text-[0.7rem] uppercase tracking-wide text-slate-400" id="theadKm">
            <tr>
              <th class="px-3 py-2">Data</th>
              <th class="px-3 py-2">Origem</th>
              <th class="px-3 py-2">Destino</th>
              <th class="px-3 py-2 text-right">KM</th>
              <th class="px-3 py-2 text-right">KM 0,30</th>
              <th class="px-3 py-2 text-right">KM 0,60</th>
              <th class="px-3 py-2 text-right">KM 0,90</th>
              <th class="px-3 py-2 text-right">R$ 0,30</th>
              <th class="px-3 py-2 text-right">R$ 0,60</th>
              <th class="px-3 py-2 text-right">R$ 0,90</th>
              <th class="px-3 py-2 text-right">Total</th>
            </tr>
          </thead>
          <tbody id="tbodyVoos" class="divide-y divide-slate-800/80">
            <tr>
              <td colspan="11" class="px-3 py-6 text-center text-xs text-slate-400">
                Aguardando arquivo e sele√ß√£o de m√™s‚Ä¶
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/* ==========================
   CONFIGURA√á√ïES
========================== */
const TAR30 = 0.30; // 06‚Äì18
const TAR60 = 0.60; // 18‚Äì06
const TAR90 = 0.90; // domingo/feriado

// Colunas (IGUAL ao teu padr√£o)
const COL_DATA       = 0;   // A
const COL_MATRICULA  = 2;   // C
const COL_ORIGEM     = 10;  // K
const COL_DESTINO    = 11;  // L
const COL_DIST_KM    = 12;  // M
const COL_DECOL_ZULU = 14;  // O
const COL_POUSO_ZULU = 15;  // P

// URL feriados (o mesmo que voc√™ j√° usa nos testes)
const FERIADOS_JSON_URL = "/assets/feriados.json";

/* ==========================
   ELEMENTOS
========================== */
const fileVoos      = document.getElementById("fileVoos");
const feriadosInfo  = document.getElementById("feriadosInfo");
const btnProcessar  = document.getElementById("btnProcessar");
const statusBox     = document.getElementById("statusBox");
const sheetPicker   = document.getElementById("sheetPicker");
const sheetInfo     = document.getElementById("sheetInfo");

const tbodyVoos     = document.getElementById("tbodyVoos");
const totaisTrip    = document.getElementById("totaisTrip");
const totaisMat     = document.getElementById("totaisMat");

let workbookVoos   = null;
let selectedSheet  = null;
let FERIADOS_SET   = new Set();

/* ==========================
   UTILS
========================== */
function setStatus(text, isError=false){
  statusBox.textContent = text;
  statusBox.className = "text-xs mb-3 " + (isError ? "text-rose-400" : "text-slate-400");
}

function formatDateBR(d){ return d.toLocaleDateString("pt-BR"); }
function fmtMoney(v){ return (v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }
function fmtNum(v, dec){ return (v||0).toLocaleString("pt-BR",{minimumFractionDigits:dec, maximumFractionDigits:dec}); }

function addDays(d,n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+n); }
function dateOnly(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function addMinutes(dt, mins){ return new Date(dt.getTime() + mins*60000); }

function isBrazil(icao){
  if(!icao) return false;
  const pfx = ["SB","SD","SI","SJ","SN","SW","SS"];
  const up = String(icao).trim().toUpperCase();
  return pfx.some(p => up.startsWith(p));
}

function convertZuluToLocal(utcDate, icao){
  if(!utcDate) return null;
  if(!isBrazil(icao)) return utcDate; // fora do BR, mant√©m Z
  let offset = -3;
  if(String(icao).trim().toUpperCase()==="SBFN") offset = -2;

  const y  = utcDate.getUTCFullYear();
  const m  = utcDate.getUTCMonth();
  const d  = utcDate.getUTCDate();
  const hh = utcDate.getUTCHours() + offset;
  const mm = utcDate.getUTCMinutes();
  const ss = utcDate.getUTCSeconds();

  return new Date(y, m, d, hh, mm, ss);
}

function parseExcelDate(v){
  if(!v) return null;
  if(v instanceof Date){
    return new Date(v.getFullYear(), v.getMonth(), v.getDate());
  }
  if(typeof v === "number"){
    const excelEpoch = new Date(Date.UTC(1899,11,30));
    const d  = new Date(excelEpoch.getTime() + v*86400000);
    return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
  }
  if(typeof v === "string"){
    const raw = v.split("T")[0].split(" ")[0];
    const parts = raw.split(/[\/\-]/);
    if(parts.length===3){
      let y,m,d;
      if(parts[0].length===4){ y=+parts[0]; m=+parts[1]; d=+parts[2]; }
      else { d=+parts[0]; m=+parts[1]; y=+parts[2]; }
      return new Date(y, m-1, d);
    }
    const tentative = new Date(v);
    if(!isNaN(tentative)) return new Date(tentative.getFullYear(), tentative.getMonth(), tentative.getDate());
  }
  return null;
}

function parseHora(h){
  if(!h) return {h:0,m:0,s:0};
  if(h instanceof Date){
    return {h:h.getUTCHours(), m:h.getUTCMinutes(), s:h.getUTCSeconds()};
  }
  if(typeof h==="number"){
    const total = Math.round(h * 86400);
    return { h:Math.floor(total/3600), m:Math.floor((total%3600)/60), s:total%60 };
  }
  if(typeof h==="string"){
    const m = h.trim().match(/(\d{1,2}:\d{2}(?::\d{2})?)$/);
    const str = m ? m[1] : h;
    const p = str.split(":");
    return { h:parseInt(p[0]||"0",10), m:parseInt(p[1]||"0",10), s:parseInt(p[2]||"0",10) };
  }
  return {h:0,m:0,s:0};
}

/* ==========================
   FERIADOS
========================== */
function keyDate(d){
  return d.getFullYear() + "-" +
         String(d.getMonth()+1).padStart(2,"0") + "-" +
         String(d.getDate()).padStart(2,"0");
}
function isHoliday(d){
  return FERIADOS_SET.has(keyDate(d));
}

async function carregarFeriadosAutomatico(){
  feriadosInfo.textContent = "Carregando feriados‚Ä¶";

  try{
    const r = await fetch(
      FERIADOS_JSON_URL + "?v=" + Date.now(), // üîë quebra cache SharePoint
      {
        cache: "no-store",
        credentials: "omit"
      }
    );

    if(!r.ok){
      throw new Error("HTTP " + r.status);
    }

    // SharePoint pode devolver TEXT
    const txt = (await r.text()).replace(/^\uFEFF/, "");
    let lista;

    try{
      lista = JSON.parse(txt);
    } catch(e){
      console.error("Falha ao interpretar feriados.json:", e, txt);
      throw new Error("JSON inv√°lido");
    }

    if(!Array.isArray(lista)){
      throw new Error("Formato inv√°lido de feriados");
    }

    FERIADOS_SET = new Set(lista);

    feriadosInfo.textContent =
      `Feriados carregados: ${FERIADOS_SET.size} data(s).`;

    console.log("‚úî Feriados carregados:", FERIADOS_SET);

  } catch(err){
    console.error("‚úñ Erro ao carregar feriados:", err);
    feriadosInfo.textContent =
      "Falha ao carregar feriados (c√°lculo seguir√° sem feriados).";

    // fallback seguro
    FERIADOS_SET = new Set();
  }
}


/* ==========================
   MOTOR DE TARIFA (IGUAL AO ASPX)
========================== */
function calcularRemuneracaoKm(startLocal, endLocal, distKm){
  const totalMin = (endLocal - startLocal)/60000;
  if(totalMin <= 0 || !isFinite(totalMin) || distKm <= 0){
    return { km30:0, km60:0, km90:0, val30:0, val60:0, val90:0, valorTotal:0 };
  }

  let km30 = 0, km60 = 0, km90 = 0;
  let cursor = new Date(startLocal);

  while(cursor < endLocal){
    const dia = dateOnly(cursor);
    const isDomingo = (dia.getDay() === 0);
    const feriado   = isHoliday(dia);

    const meiaNoite = addDays(dia,1);
    const limiteDia = meiaNoite < endLocal ? meiaNoite : endLocal;

    if(isDomingo || feriado){
      const minutos = (limiteDia - cursor)/60000;
      const frac = minutos / totalMin;
      km90 += distKm * frac;
      cursor = limiteDia;
      continue;
    }

    const t06 = new Date(dia.getFullYear(), dia.getMonth(), dia.getDate(), 6,0,0);
    const t18 = new Date(dia.getFullYear(), dia.getMonth(), dia.getDate(), 18,0,0);

    const acumular = (ini, fim, tipoTarifa) => {
      const inicio = ini < cursor ? cursor : ini;
      const fimEf  = fim > limiteDia ? limiteDia : fim;
      if(fimEf <= inicio) return;
      const minutos = (fimEf - inicio)/60000;
      const frac = minutos / totalMin;
      const km = distKm * frac;
      if(tipoTarifa === "30") km30 += km;
      else if(tipoTarifa === "60") km60 += km;
      else km90 += km;
    };

    // 00‚Äì06 => 0,60
    acumular(dia, t06, "60");
    // 06‚Äì18 => 0,30
    acumular(t06, t18, "30");
    // 18‚Äì24 => 0,60
    acumular(t18, limiteDia, "60");

    cursor = limiteDia;
  }

  const val30 = km30 * TAR30;
  const val60 = km60 * TAR60;
  const val90 = km90 * TAR90;
  const valorTotal = val30 + val60 + val90;

  return { km30, km60, km90, val30, val60, val90, valorTotal };
}

/* ==========================
   LEITURA DO EXCEL + ABAS
========================== */
fileVoos.addEventListener("change", () => {
  workbookVoos = null;
  selectedSheet = null;

  sheetPicker.innerHTML = "";
  sheetInfo.textContent = "";
  btnProcessar.disabled = true;

  tbodyVoos.innerHTML = `
    <tr>
      <td colspan="11" class="px-3 py-6 text-center text-xs text-slate-400">
        Selecione o m√™s (aba) para processar.
      </td>
    </tr>`;
  totaisTrip.innerHTML = "";
  totaisMat.innerHTML = "";

  const files = fileVoos.files;
  if(!files || files.length===0){
    setStatus("Selecione a planilha de voos para continuar.");
    return;
  }

  const file = files[0];
  setStatus("Lendo estrutura do arquivo Excel‚Ä¶");

  const reader = new FileReader();
  reader.onload = (e) => {
    try{
      const data = new Uint8Array(e.target.result);
      workbookVoos = XLSX.read(data, {type:"array"});

      const mesesAlvo = [
        "JANEIRO","FEVEREIRO","MAR√áO","ABRIL","MAIO","JUNHO",
        "JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"
      ];

      const sheets = workbookVoos.SheetNames.filter(n =>
        mesesAlvo.includes(String(n).toUpperCase())
      );

      if(sheets.length === 0){
        setStatus("Nenhuma aba mensal (JANEIRO‚Ä¶DEZEMBRO) encontrada no arquivo.", true);
        return;
      }

      sheetPicker.innerHTML = "";
      sheets.forEach(name => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className =
          "px-2.5 py-1 rounded-full text-[0.7rem] border border-slate-600/60 " +
          "text-slate-200 hover:bg-slate-800/80";
        btn.textContent = name;

        btn.addEventListener("click", () => {
          selectedSheet = name;
          sheetInfo.textContent = "M√™s selecionado: " + name;
          Array.from(sheetPicker.children).forEach(c=>{
            c.classList.remove("bg-sky-600/80","border-sky-400");
          });
          btn.classList.add("bg-sky-600/80","border-sky-400");
          btnProcessar.disabled = false;
          setStatus(`Aba "${name}" pronta. Clique em Processar remunera√ß√£o.`);
        });

        sheetPicker.appendChild(btn);
      });

      setStatus("Arquivo lido. Escolha o m√™s (aba) para processar.");
    } catch(err){
      console.error(err);
      setStatus("Erro ao ler o arquivo Excel.", true);
    }
  };
  reader.readAsArrayBuffer(file);
});

/* ==========================
   PROCESSAR
========================== */
btnProcessar.addEventListener("click", () => {
  if(!workbookVoos || !selectedSheet){
    alert("Selecione a planilha de voos e o m√™s (aba) antes de processar.");
    return;
  }

  tbodyVoos.innerHTML = `
    <tr>
      <td colspan="11" class="px-3 py-6 text-center text-xs text-slate-400">
        Processando aba "${selectedSheet}"‚Ä¶
      </td>
    </tr>`;
  btnProcessar.disabled = true;

  totaisTrip.innerHTML = "";
  totaisMat.innerHTML = "";
  setStatus(`Processando aba "${selectedSheet}"‚Ä¶`);

  try{
    const ws  = workbookVoos.Sheets[selectedSheet];
    const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});

    if(!aoa || aoa.length < 2){
      setStatus("Aba sem dados suficientes.", true);
      btnProcessar.disabled = false;
      return;
    }

    const header = aoa[0] || [];

    // Tripulantes: pega o que existir entre D..I (colunas 3..8) COMO NO ASPX
    const TRIP_CODES = [];
    const TRIP_COLS  = [];
    for(let col=3; col<=8; col++){
      const v = (header[col] || "").toString().trim();
      if(v){
        TRIP_CODES.push(v);
        TRIP_COLS.push({code:v, col});
      }
    }

    const porTrip = {};
    const porMatTrip = {};
    TRIP_CODES.forEach(t => porTrip[t] = 0);

    tbodyVoos.innerHTML = "";
    const frag = document.createDocumentFragment();

    for(let i=1; i<aoa.length; i++){
      const r = aoa[i];
      if(!r) continue;

      if(!r[COL_DATA] || !r[COL_DECOL_ZULU] || !r[COL_POUSO_ZULU]) continue;

      const valData = r[COL_DATA];
      const o = (r[COL_ORIGEM]  || "").toString().trim().toUpperCase();
      const d = (r[COL_DESTINO] || "").toString().trim().toUpperCase();
      const mat = (r[COL_MATRICULA] || "").toString().trim() || "(sem matr√≠cula)";

      let km = r[COL_DIST_KM];
      km = parseFloat(String(km).replace(",", "."));
      if(!isFinite(km) || km <= 0) continue;

      const dataBase = parseExcelDate(valData);
      if(!dataBase) continue;

      const tDec = parseHora(r[COL_DECOL_ZULU]);
      const tPou = parseHora(r[COL_POUSO_ZULU]);

      let zStart = new Date(Date.UTC(
        dataBase.getFullYear(), dataBase.getMonth(), dataBase.getDate(),
        tDec.h, tDec.m, tDec.s
      ));
      let zEnd = new Date(Date.UTC(
        dataBase.getFullYear(), dataBase.getMonth(), dataBase.getDate(),
        tPou.h, tPou.m, tPou.s
      ));
      if(zEnd <= zStart) zEnd = addMinutes(zEnd, 1440);

      const start = convertZuluToLocal(zStart, o);
      const end   = convertZuluToLocal(zEnd,   d);

      // üîç Valida√ß√£o de tripula√ß√£o (EXATAMENTE 2)
const tripMarcados = TRIP_COLS.filter(tc => {
  return String(r[tc.col] || "").trim().toUpperCase() === "X";
});

if(tripMarcados.length !== 2){
  // Marca erro de base
  const tr = document.createElement("tr");
  tr.className = "bg-rose-900/40 text-rose-200";

  tr.innerHTML = `
    <td class="px-3 py-1.5">${formatDateBR(parseExcelDate(r[COL_DATA]) || new Date())}</td>
    <td class="px-3 py-1.5">${o}</td>
    <td class="px-3 py-1.5">${d}</td>
    <td colspan="8" class="px-3 py-1.5 text-left font-semibold">
      ‚ùå ERRO DE TRIPULA√á√ÉO ‚Äî ${tripMarcados.length} tripulante(s) marcado(s)
    </td>
  `;

  frag.appendChild(tr);
  continue; // ‚õî N√ÉO CALCULA ESTA LINHA
}


      const res = calcularRemuneracaoKm(start, end, km);

      // Render tabela (igual ao core simples, mas com layout tailwind)
      const tr = document.createElement("tr");
      tr.className = "hover:bg-slate-900/70";
      tr.innerHTML = `
        <td class="px-3 py-1.5">${formatDateBR(dateOnly(start))}</td>
        <td class="px-3 py-1.5">${o}</td>
        <td class="px-3 py-1.5">${d}</td>
        <td class="px-3 py-1.5 text-right">${fmtNum(km,1)}</td>
        <td class="px-3 py-1.5 text-right">${fmtNum(res.km30,1)}</td>
        <td class="px-3 py-1.5 text-right">${fmtNum(res.km60,1)}</td>
        <td class="px-3 py-1.5 text-right">${fmtNum(res.km90,1)}</td>
        <td class="px-3 py-1.5 text-right text-emerald-300">${fmtMoney(res.val30)}</td>
        <td class="px-3 py-1.5 text-right text-sky-300">${fmtMoney(res.val60)}</td>
        <td class="px-3 py-1.5 text-right text-amber-300">${fmtMoney(res.val90)}</td>
        <td class="px-3 py-1.5 text-right text-slate-50 font-semibold">${fmtMoney(res.valorTotal)}</td>
      `;
      frag.appendChild(tr);

      // Totais por tripulante (100% do valor do voo, como seu calckm.aspx)
      TRIP_COLS.forEach(tc => {
        const mark = (r[tc.col] || "").toString().trim().toUpperCase();
        if(mark !== "X") return;

        porTrip[tc.code] = (porTrip[tc.code] || 0) + res.valorTotal;

        porMatTrip[tc.code] ??= {};
        porMatTrip[tc.code][mat] = (porMatTrip[tc.code][mat] || 0) + res.valorTotal;
      });
    }

    tbodyVoos.appendChild(frag);

    // Render totais (layout do card)
    totaisTrip.innerHTML = "";
    totaisMat.innerHTML = "";

    const tripList = Object.keys(porTrip).filter(t => porTrip[t] > 0);

    if(tripList.length === 0){
      totaisTrip.innerHTML = `<span class="text-slate-400 text-xs">Nenhum tripulante marcado (X) nas colunas D..I.</span>`;
      totaisMat.innerHTML  = `<span class="text-slate-400 text-xs">‚Äî</span>`;
    } else {
      tripList.forEach(t => {
        const chip = document.createElement("div");
        chip.className = "px-3 py-1.5 rounded-xl bg-slate-900/80 border border-slate-700/60 text-[0.78rem]";
        chip.innerHTML = `<span class="font-semibold text-slate-100">${t}</span> ‚Äî <span class="text-emerald-300">${fmtMoney(porTrip[t])}</span>`;
        totaisTrip.appendChild(chip);

        let block = `<div class="rounded-xl bg-slate-900/60 border border-slate-700/60 p-2">
          <div class="font-semibold text-slate-100 mb-1">${t}</div>`;
        const mats = porMatTrip[t] || {};
        Object.keys(mats).sort().forEach(m => {
          block += `<div class="ml-2 text-[0.75rem] text-slate-200">${m}: <span class="text-emerald-300 font-semibold">${fmtMoney(mats[m])}</span></div>`;
        });
        block += `</div>`;
        totaisMat.innerHTML += block;
      });
    }

    setStatus(`Processamento conclu√≠do (${selectedSheet}).`);
  } catch(err){
    console.error(err);
    setStatus("Erro ao processar a aba selecionada.", true);
    tbodyVoos.innerHTML = `
      <tr>
        <td colspan="11" class="px-3 py-6 text-center text-xs text-rose-400">
          Erro ao processar a aba. Verifique o arquivo e tente novamente.
        </td>
      </tr>`;
  } finally {
    btnProcessar.disabled = false;
  }
});

/* ==========================
   INIT
========================== */
carregarFeriadosAutomatico();
</script>

</body>
</html>
